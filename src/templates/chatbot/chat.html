{% extends 'main/base.html' %}
{% block title %}{{ user_profile.username }}{% endblock %}

{% load i18n %}
{% load static %}
{% load profile_components %}

{% block content %}
<div class="container p-6 w-[800px]">
  <h1 class="text-3xl tracking-tight font-light" id="chat-header"></h1>
  <div
    id="chat-log"
    class="mt-4 w-full relative text-black p-6 overflow-y-auto h-[30rem] bg-gray-50 border border-gray-200"
  ></div>
  <div class="mt-4">
    <input
      id="chat-message-input"
      class="py-2 outline-none text-black bg-gray-50 border border-gray-300 text-gray-900 text-sm focus:border-blue-500"
      type="text"
      placeholder=""
    />
    <button
      id="chat-message-submit"
      class="py-2 px-4 ml-2 text-black border border-transparent text-sm font-medium rounded-md bg-blue-800 hover:bg-blue-900"
      type="submit"
    >
      Send
    </button>
  </div>
</div>

<script>
    const wss_protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const chatSocket = new WebSocket(
        wss_protocol + window.location.host + "/ws/chat/"
    );

    const chatMessages = []; 
    
    const chatHeader = document.querySelector("#chat-header");
    const chatLog = document.querySelector("#chat-log");
    const chatMessageInput = document.querySelector("#chat-message-input");
    const chatMessageSubmit = document.querySelector("#chat-message-submit");

    function renderMessages() {
        let str = '<ul class="space-y-2">';
        chatMessages.forEach(function (msg) {
            str += `
                <li class="flex ${msg.source === "bot" ? "justify-start" : "justify-end"}">
                    <div class="relative max-w-xl px-4 py-2 rounded-lg shadow-md
                        ${msg.source === "bot" ? "text-gray-700 bg-white border border-gray-200" : "bg-blue-600 text-black"}">
                        <span class="block font-normal">${escapeHTML(msg.msg)}</span>
                    </div>
                </li>
            `;
        });
        str += "</ul>";
        chatLog.innerHTML = str;
        chatLog.scrollTop = chatLog.scrollHeight; 
    }

    function escapeHTML(str) {
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    chatSocket.onopen = function (e) {
        if (chatHeader) {
            chatHeader.innerHTML = "Chatbot";
            console.log("WebSocket connection opened:", e);
        } else {
            console.error("Chat header element not found!");
        }
    };

    chatSocket.onmessage = function (e) {
        try {
            const data = JSON.parse(e.data);
            const message = data.text;

            if (message && message.msg && message.source) {
                chatMessages.push(message);
                renderMessages();
            } else {
                console.warn("Received invalid message format:", data);
            }
        } catch (error) {
            console.error("Error parsing WebSocket message:", error, e.data);
        }
    };

    chatSocket.onclose = function (e) {
        console.warn("WebSocket connection closed:", e);
        const disconnectedMessage = { msg: "Disconnected from chat. Please reload the page to reconnect.", source: "bot-info" };
        chatMessages.push(disconnectedMessage);
        renderMessages();
        if (chatMessageInput) chatMessageInput.disabled = true;
        if (chatMessageSubmit) chatMessageSubmit.disabled = true;
    };

    chatSocket.onerror = function (e) {
        console.error("WebSocket error:", e);
        const errorMessage = { msg: "An error occurred with the chat connection. Please try again.", source: "bot-error" };
        chatMessages.push(errorMessage);
        renderMessages();
        if (chatMessageInput) chatMessageInput.disabled = true;
        if (chatMessageSubmit) chatMessageSubmit.disabled = true;
    };

    if (chatMessageInput) {
        chatMessageInput.focus();
    } else {
        console.error("Chat message input element not found!");
    }

    if (chatMessageInput && chatMessageSubmit) {
        chatMessageInput.onkeyup = function (e) {
            if (e.key === 'Enter') {
                chatMessageSubmit.click();
            }
        };
    }

    if (chatMessageSubmit && chatMessageInput && chatSocket) {
        chatMessageSubmit.onclick = function (e) {
            const message = chatMessageInput.value.trim();
            if (message.length > 0 && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(
                    JSON.stringify({
                        text: message,
                    })
                );
                chatMessageInput.value = "";
            } else if (chatSocket.readyState !== WebSocket.OPEN) {
                console.warn("Cannot send message: WebSocket is not open.");
                const notConnectedMessage = { msg: "Cannot send. Not connected to chat.", source: "bot-info" };
                chatMessages.push(notConnectedMessage);
                renderMessages();
            }
        };
    } else {
        console.error("Chat submit button or input or socket not found/ready!");
    }

</script>
{% endblock %}
