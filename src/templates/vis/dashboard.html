{% extends 'main/base.html' %}
{% load i18n %}
{% load plotly_dash %}
{% load filters %}

{% block title %}{% translate "Visualization" %}{% endblock %}

{% block content %}
<div style="display:flex;">
  <div class="vis-sidebar d-flex flex-column flex-shrink-0 bg-dark">
    <div class="sidebar-menu">
      <div class="p-3">

        <label for="series" class="text-white">{% trans "Series" %}:</label>
        <select name="series" id="series" class="selectpicker" data-size="5">
          {% for series in available_series %}
          <option value="{{ series }}" {% if selected_series == series %}selected{% endif %}>
          {{ series.capitalize }} Series
          </option>
          {% endfor %}
        </select>

        <hr style="color:white;">

        <label for="disease" class="text-white">{% trans "Disease" %}:</label>
        <select name="disease" id="disease" class="selectpicker" data-size="5">
          {% for dis in available_diseases %}
          <option 
          value="{{ dis }}" 
          {% if dis == disease %}selected{% endif %} 
          >
          {{ dis.capitalize }}
          </option>
          {% endfor %}
        </select>

        <hr style="color:white;">

        <div id="adm-level-div">
          <label for="adm-level" class="text-white">{% trans "Administrative level" %}:</label>
          <select name="adm-level" id="adm-level" class="selectpicker" data-size="5">
            {% for level in available_adm_levels %}
            <option value="{{ level }}" {% if selected_adm_level == level %}selected{% endif %}>
            {% if level == 0 %}
            {% trans "National" %}
            {% elif level == 1 %}
            {% trans "State" %}
            {% elif level == 2 %}
            {% trans "Municipality" %}
            {% elif level == 3 %}
            {% trans "Sub Municipality" %}
            {% endif %}
            </option>
            {% endfor %}
          </select>

          <hr style="color:white;">
        </div>

        <div id="geocode-div">
          <label for="geocode" class="text-white">{% trans "Geocode" %}:</label>
          <select name="geocode" id="geocode" class="selectpicker" data-size="5" data-live-search="true">
            {% for gc in available_geocodes %}
            <option 
            value="{{ gc }}" 
            {% if gc == selected_geocodes.0 %}selected{% endif %}
            >
            {{ gc }}
            </option>
            {% endfor %}
          </select>

          <hr style="color:white;">
        </div>

        <label for="models" class="text-white">{% trans "Models" %}:</label>
        <select name="models" id="models" class="selectpicker" data-size="5" multiple>
          {% for model in models %}
          <option value="{{ model.id }}" {% if model.selected == "True" %}selected{% endif %}>
          {{ model.id }} - {{ model.id|model_name_by_id }}
          </option>
          {% endfor %}
        </select>

        <hr style="color:white;">

        <label for="predictions" class="text-white">{% trans "Predictions" %}:</label>
        <select name="predictions" id="predictions" class="selectpicker" data-size="5" multiple>
          {% for model in models %}
          {% for prediction in model.predictions %}
          <option 
          value="{{prediction.id}}" 
          {% if prediction.selected == "True" %}selected{% endif %}
          >
          {{prediction.model_id}} - Prediction {{prediction.id}}
          </option>
          {% endfor %}
          {% endfor %}
        </select>

        <br></br>

        <div class="buttons">
          <button type="button" class="btn btn-light end">{% trans "Visualize" %}</button>
        </div>

      </div>
    </div>
  </div>

  <div class="vis-content d-flex flex-column flex-shrink-0 p-3 bg-light">
    <iframe id="lineChart" src="{% url 'line_charts' %}{{line_charts_default_uri}}" width="100%" height="500" frameborder="0"></iframe>
    <div class="container">{{ compatibilities|safe }}</div>
  </div>

</div>


<style>
.vis-sidebar {
  width: 280px;
  min-height: calc(100vh - 211px);
}

.vis-content {
  flex-grow: 1;
  min-height: calc(100vh - 211px);
}
</style>

<script>
  $(document).ready(function () {

    disableDefaults();

    var compabilities = {{ compatibilities|safe }};
    var chartsInfo = {{ charts_info|safe }};
    var lineChart = chartsInfo.LineChartADM2;

    var allModels = [];
    for (var i = 0; i < lineChart.length; i++) {
      // get all models from view [lineChart]
      var model = lineChart[i];
      if (allModels.indexOf(model.id) === -1) {
        allModels.push(model.id);
      }
    };
    
    var selectedSeries;

    $('#series').change(function () {
      selectedSeries = $(this).val();
      disableOnSeries(selectedSeries);
    });

    console.log(selectedSeries);

    $('#disease').change(function () {
      var selectedDisease = $(this).val();
    });

    $('#adm-level').change(function () {
      var selectedADMLevel = $(this).val();

      if (selectedADMLevel === '2') {
        $('#geocode-div').show();
      } else {
        $('#geocode-div').hide();
      }
    });

    $('#geocode').change(function () {
      var selectedGeocode = $(this).val();
    });

    $('#models').change(function () {
      var selectedModelIds = $(this).val();
      disablePredictionsButFor(selectedModelIds);
    });

    $('#predictions').change(function () {
      var selectedPredictIds = $(this).val();
    });

    function disableDefaults() {
      // This function will disable all items that should be disabled by
      // default
      var defaultSeries = $('#series').val()
      var defaultDisease = $('#disease').val()
      var defaultADMLevel = $('#adm-level').val()
      var defaultModels = $('#models').val();
      var defaultPredictions = $('#predictions').val()

      disableOnSeries(defaultSeries);
    }


    function getItems(
      series = null, 
      disease = null, 
      admLevel = null, 
      geocode = null, 
      modelId = null
    ) {
      // console.log(series);
      // console.log(disease);
      // console.log(admLevel);
      // console.log(geocode);
      // console.log(modelId);
      function filterEmptyDictionaries(obj) {
        for (let key in obj) {
          if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
            obj[key] = filterEmptyDictionaries(obj[key]);
            if (Object.keys(obj[key]).length === 0) {
              delete obj[key];
            }
          }
        }
        return obj;
      }

      var compatibilities = {{ compatibilities|safe }};

      let result = compatibilities;
      if (series !== null ) {
        result = result[series];
        if (disease !== null) {
          result = result[disease];
          if (admLevel !== null) {
            result = result[admLevel.toString()];
            if (admLevel.toString() === "2") {
              if (geocode !== null) {
                result = result[geocode.toString()];
                if (modelId !== null) {
                  result = result[modelId.toString()];
                } 
              }
            } else { // TODO: add logic for "0", "1" and "3"
              if (modelId !== null) {
                result = result[modelId.toString()];
              }
            }
          }
        }
      }

      if (!Array.isArray(result)) {
        result = filterEmptyDictionaries(result);
        return Object.keys(result);
      } else {
        return result;
      }
    }


    function disableOnSeries(selectedSeries) {
      let availableDiseases = {{ available_diseases|safe }}
      let diseases = getItems(series=selectedSeries);

      let count = 0;
      for (var d = 0; d < availableDiseases.length; d++) {
        let disease = availableDiseases[d];
        if (diseases.includes(disease)) {
          $('#disease option[value="' + disease + '"]').prop('disabled', false);
          $('#disease').selectpicker('refresh');
          if (count === 0) {
            $('#disease option[value="' + disease + '"]').prop('selected', true);
            $('#disease').selectpicker('refresh');
            disableOnDisease(series=selectedSeries, selectedDisease=disease);
            count++;
          }
        } else {
          $('#disease option[value="' + disease + '"]').prop('disabled', true);
          $('#disease').selectpicker('refresh');
        }
      }
    }

    function disableOnDisease(series, selectedDisease) {
      let availableADMLevels = {{ available_adm_levels }};
      let admLevels = getItems(series=series, disease=selectedDisease)

      let count = 0;
      for (var a = 0; a < availableADMLevels.length; a++) {
        let admLevel = availableADMLevels[a].toString();
        if (admLevels.includes(admLevel)) {
          $('#adm-level option[value="' + admLevel + '"]').prop('disabled', false);
          $('#adm-level').selectpicker('refresh');
          if (count === 0) {
            $('#adm-level option[value="' + admLevel + '"]').prop('selected', true);
            $('#adm-level').selectpicker('refresh');
            disableOnADMLevel(
              series=series, 
              selectedDisease=disease, 
              selectedADMLevel=admLevel,
            );
            count++;
          }
        } else {
          $('#adm-level option[value="' + admLevel + '"]').prop('disabled', true);
          $('#adm-level').selectpicker('refresh');
        }
      }
    }


    function disableOnADMLevel(series, selectedDisease, selectedADMLevel) {
      if (selectedADMLevel === '2') {
        $('#geocode-div').show();
        let availableGeocodes = {{ available_geocodes }};
        let geocodes = getItems(
          series=series,
          disease=selectedDisease,
          admLevel=selectedADMLevel,
        )

        let count = 0;
        for (var g = 0; g < availableGeocodes.length; g++) {
          let geocode = availableGeocodes[g];
          if (geocodes.includes(geocode.toString())) {
            $('#geocode option[value="' + geocode + '"]').prop('disabled', false);
            $('#geocode').selectpicker('refresh');
            if (count === 0) {
              $('#geocode option[value="' + geocode + '"]').prop('selected', true);
              $('#geocode').selectpicker('refresh');
              disableOnGeocode(
                series=series,
                selectedDisease=selectedDisease,
                selectedADMLevel=selectedADMLevel,
                selectedGeocode=geocode,
              );
              count++;
            }
          } else {
            $('#geocode option[value="' + geocode + '"]').prop('disabled', true);
            $('#geocode').selectpicker('refresh');
          }
        }
      } else { // TODO: Handle '0', '1' and '3' cases individually
        $('#geocode-div').hide();
        let modelIds = getItems(
          series=series,
          disease=selectedDisease,
          admLevel=selectedADMLevel,
        );
        console.log(modelIds);
      }
    }

    function disableOnGeocode(
      series, 
      selectedDisease, 
      selectedADMLevel, 
      selectedGeocode
    ) {
      let modelIds = getItems(
        series=series,
        disease=selectedDisease,
        admLevel=selectedADMLevel,
        geocode=selectedGeocode,
      );

      $("#models").empty();
      $("#predictions").empty();

      for (var m = 0; m < modelIds.length; m++) {
        modelId = modelIds[m];

        getModelItemDesc(modelId)
          .then(result => {
            var opt = document.createElement('option');
            opt.value = modelId;   
            opt.innerHTML = modelId + " - " + result.name;
            $("#models").append(opt).selectpicker('refresh');
          })
          .catch(error => {
            console.error('Error:', error.message);
        });

        disableOnModelId(
          series=series,
          selectedDisease=selectedDisease,
          selectedADMLevel=selectedADMLevel,
          selectedModelId=modelId,
          selectedGeocode=selectedGeocode,
        );
      }

      $('#models').selectpicker('refresh');
      $('#predictions').selectpicker('refresh');
    }

    function disableOnModelId(
      series, 
      selectedDisease, 
      selectedADMLevel, 
      selectedModelId,
      selectedGeocode = null,
    ) {
      if (selectedADMLevel.toString() === "2" && selectedGeocode !== null) {
        let predictionIds = getItems(
          series=series,
          disease=selectedDisease,
          admLevel=selectedADMLevel,
          geocode=selectedGeocode,
          modelId=selectedModelId
        );
        console.log(predictionIds);
      } else if (selectedADMLevel.toString() === "0" && selectedGeocode === null) {
        let predictionIds = getItems(
          series=series,
          disease=selectedDisease,
          admLevel=selectedADMLevel,
          modelId=selectedModelId
        );
        console.log(predictionIds);
      } // TODO: Add more cases here to handle other adm levels

      // console.log(predictionIds);
    }


    function disablePredictionsButFor(modelIds) {
      // TODO: lineChart will have to change when more vis are available
      for (var i = 0; i < lineChart.length; i++) {
        var model = lineChart[i];
        for (var p = 0; p < model.predictions.length; p++) {
          if (modelIds.includes(model.id.toString())) {
            $('#predictions option[value="' + model.predictions[p].id + '"]').prop('disabled', false);
            $('#predictions').selectpicker('refresh');
          } else {
            $('#predictions option[value="' + model.predictions[p].id + '"]').prop('disabled', true).prop('selected', false);
            $('#predictions').selectpicker('refresh');
          }
        }
      }
    }

    function getModelItemDesc(modelId) {
      return fetch(`/vis/get-model-item/${modelId}/`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error fetching model: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => data)
        .catch(error => {
          console.error('Error:', error.message);
        });
    }


    function getGeocodes(predictionIds) {
      // TODO: lineChart will change later on
      var geocodes = [];

      for (var i = 0; i < lineChart.length; i++) {
        var model = lineChart[i];
        for (var p = 0; p < model.predictions.length; p++) {
          prediction = model.predictions[p];
          if (predictionIds.includes(prediction.id.toString())) {
            geocodes.push(prediction.geocodes);
          }
        }
      }
      return geocodes
    }

  });

</script>
{% endblock %}
