{% extends 'main/base.html' %}
{% load i18n %}
{% load plotly_dash %}
{% load filters %}

{% block title %}{% translate "Visualization" %}{% endblock %}

{% block content %}
<div style="display:flex;">
  <div class="vis-sidebar d-flex flex-column flex-shrink-0 bg-dark">
    <div class="sidebar-menu">
      <div class="p-3">

        <label for="models" class="text-white">{% trans "Models" %}:</label>
        <select name="models" id="models" class="selectpicker" data-size="5" multiple>
            {% for model in models %}
                <option value="{{ model.id }}" {% if model.selected == "True" %}selected{% endif %}>
                    {{ model.id }} - {{ model.id|model_name_by_id }}
                </option>
            {% endfor %}
        </select>

        <hr style="color:white;">

        <label for="predictions" class="text-white">{% trans "Predictions" %}:</label>
        <select name="predictions" id="predictions" class="selectpicker" data-size="5" multiple>
          {% for model in models %}
            {% for prediction in model.predictions %}
              <option value="{{prediction.id}}" {% if prediction.selected == "True" %}selected{% endif %}>{{prediction.model_id}} - Prediction {{prediction.id}}</option>
            {% endfor %}
          {% endfor %}
        </select>

        <hr style="color:white;">

        <label for="disease" class="text-white">{% trans "Disease" %}:</label>
        <select name="disease" id="disease" class="selectpicker" data-size="5">
          {% for disease, ids in diseases.items %}
            <option value="{{ disease }}" {% if ids|is_empty %}disabled{% endif %}>
            {{ disease.capitalize }}
            </option>
          {% endfor %}
        </select>

        <hr style="color:white;">

        <label for="geocode" class="text-white">{% trans "Geocode" %}:</label>
        <select name="geocode" id="geocode" class="selectpicker" data-size="5" data-live-search="true">
            <option value="geocode">geocode</option>
        </select>


      </div>
    </div>
  </div>

  <div class="vis-content d-flex flex-column flex-shrink-0 p-3 bg-light">
      <iframe id="lineChart" src="{% url 'line_charts' %}{{line_charts_default_uri}}" width="100%" height="500" frameborder="0"></iframe>
      <p>{{ charts_info|safe }}</p>
  </div>
</div>


<style>
.vis-sidebar {
  width: 280px;
  min-height: calc(100vh - 211px);
}

.vis-content {
  flex-grow: 1;
  min-height: calc(100vh - 211px);
}
</style>

<script>
$(document).ready(function () {
    var chartsInfo = {{ charts_info|safe }};
    var lineChart = chartsInfo.LineChart;
    
    var allModels = [];
    for (var i = 0; i < lineChart.length; i++) {
        // get all models from view [lineChart]
        var model = lineChart[i];
        if (allModels.indexOf(model.id) === -1) {
            allModels.push(model.id);
        }
    };

    // disable predictions for models not selected by default
    var defaultModels = $('#models').val(); // from views
    disablePredictionsButFor(defaultModels);
    
    let toEnable = {};

    $('#models').change(function () {
        var selectedModelIds = $(this).val();
        disablePredictionsButFor(selectedModelIds);
    });

    $('#predictions').change(function () {
        var selectedPredictIds = $(this).val();
        var geocodes = [];

        for (var i = 0; i < lineChart.length; i++) {
            var model = lineChart[i];
            for (var p = 0; p < model.predictions.length; p++) {
                prediction = model.predictions[p];
                if (selectedPredictIds.includes(prediction.id.toString())) {
                    geocodes.push(prediction.geocodes);
                }
            }
        }

        $("#geocode").empty();
        enableGeocodes(geocodes);
        $("#geocode").selectpicker("refresh");
    });

    $('#geocode').change(function () {
        var selectedGeocode = $(this).val();
        console.log(selectedGeocode);
    });

    function disablePredictionsButFor(modelIds) {
        // TODO: lineChart will have to change when more vis are available
        for (var i = 0; i < lineChart.length; i++) {
            var model = lineChart[i];
            for (var p = 0; p < model.predictions.length; p++) {
                if (modelIds.includes(model.id.toString())) {
                    $('#predictions option[value="' + model.predictions[p].id + '"]').prop('disabled', false);
                    $('#predictions').selectpicker('refresh');
                } else {
                    $('#predictions option[value="' + model.predictions[p].id + '"]').prop('disabled', true).prop('selected', false);
                    $('#predictions').selectpicker('refresh');
                }
            }
        }
    }

    function enableGeocodes(geocodes) {
        if (geocodes && geocodes.length > 0) {
            res = geocodes.reduce((a, b) => a.filter(c => b.includes(c)));
            for (var g = 0; g < res.length; g++) {
                var geocode = res[g];
                var opt = document.createElement('option');
                opt.value = geocode;
                opt.innerHTML = geocode;
                $("#geocode").append(opt).selectpicker("refresh");
            }
        }
    }
});

</script>
{% endblock %}
