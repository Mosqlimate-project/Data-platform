{% extends 'main/base.html' %}
{% load i18n %}
{% load plotly_dash %}
{% load filters %}

{% block title %}{% translate "Visualization" %}{% endblock %}

{% block content %}
<div style="display:flex;">
  <div class="vis-sidebar d-flex flex-column flex-shrink-0 bg-dark">
    <div class="sidebar-menu">
      <div class="p-3">
        <center><b>
            <label for="diseaseRadio" class="text-white">{% trans "Disease" %}</label>
          </b></center>
          <div class="form-check">
            <input 
            class="form-check-input" 
            type="radio" 
            name="diseaseRadio" 
            id="dengue"
            {% if "dengue" not in diseases %}disabled{% endif %}
            >
            <label class="form-check-label text-white" for="dengue">Dengue</label>
          </div>
          <div class="form-check">
            <input 
            class="form-check-input" 
            type="radio" 
            name="diseaseRadio" 
            id="zika"
            {% if "zika" not in diseases %}disabled{% endif %}
            >
            <label class="form-check-label text-white" for="zika">Zika</label>
          </div>
          <div class="form-check">
            <input 
            class="form-check-input" 
            type="radio" 
            name="diseaseRadio" 
            id="chik"
            {% if "chikungunya" not in diseases %}disabled{% endif %}
            >
            <label class="form-check-label text-white" for="chik">Chikungunya</label>
          </div>

          <hr style="color:white;">

          <center><b>
              <label for="timeResRadio" class="text-white">{% trans "Temporal Resolution" %}</label>
            </b></center>
            <div class="form-check">
              <input 
              class="form-check-input" 
              type="radio" 
              name="timeResRadio" 
              id="day"
              {% if "day" not in time_resolutions %}disabled{% endif %}
              >
              <label class="form-check-label text-white" for="day">Daily</label>
            </div>
            <div class="form-check">
              <input 
              class="form-check-input" 
              type="radio" 
              name="timeResRadio" 
              id="week"
              {% if "week" not in time_resolutions %}disabled{% endif %}
              >
              <label class="form-check-label text-white" for="week">Weekly</label>
            </div>
            <div class="form-check">
              <input 
              class="form-check-input" 
              type="radio" 
              name="timeResRadio" 
              id="month"
              {% if "month" not in time_resolutions %}disabled{% endif %}
              >
              <label class="form-check-label text-white" for="month">Monthly</label>
            </div>
            <div class="form-check">
              <input 
              class="form-check-input" 
              type="radio" 
              name="timeResRadio" 
              id="year"
              {% if "year" not in time_resolutions %}disabled{% endif %}
              >
              <label class="form-check-label text-white" for="year">Yearly</label>
            </div>

            <hr style="color:white;">

            <center><b>
                <label for="admLevelRadio" class="text-white">{% trans "Administrative Level" %}</label>
              </b></center>
              <div class="form-check">
                <input 
                class="form-check-input" 
                type="radio" 
                name="admLevelRadio" 
                id="national"
                value=0
                {% if 0 not in adm_levels %}disabled{% endif %}
                >
                <label class="form-check-label text-white" for="national">National</label>
              </div>
              <div class="form-check">
                <input 
                class="form-check-input" 
                type="radio" 
                name="admLevelRadio" 
                id="state"
                value=1
                {% if 1 not in adm_levels %}disabled{% endif %}
                >
                <label class="form-check-label text-white" for="state">State</label>
              </div>
              <div class="form-check">
                <input 
                class="form-check-input" 
                type="radio" 
                name="admLevelRadio" 
                id="municipal"
                value=2
                {% if 2 not in adm_levels %}disabled{% endif %}
                >
                <label class="form-check-label text-white" for="municipal">Municipal</label>
              </div>
              <div class="form-check">
                <input 
                class="form-check-input" 
                type="radio" 
                name="admLevelRadio" 
                id="submunicipal"
                value=3
                {% if 3 not in adm_levels %}disabled{% endif %}
                >
                <label class="form-check-label text-white" for="submunicipal">Sub Municipal</label>
              </div>

              <hr style="color:white;">

              <center><b>
                  <label for="modelType" class="text-white">{% trans "Model Type" %}</label>
                </b></center>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="checkbox" 
                  value="" 
                  id="spatialType" 
                  {% if "spatial" not in model_types %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="spatialType">
                    Spatial
                  </label>
                </div>
                <div class="form-check">
                  <input
                  class="form-check-input" 
                  type="checkbox" 
                  value="" 
                  id="temporalType" 
                  {% if "temporal" not in model_types %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="temporalType">
                    Temporal
                  </label>
                </div>

                <hr style="color:white;">

                <center><b>
                    <label for="outputFormat" class="text-white">{% trans "Output Format" %}</label>
                  </b></center>
                  <div class="form-check">
                    <input
                    class="form-check-input" 
                    type="radio" 
                    name="outputFormat" 
                    id="categorical" 
                    value="C" 
                    {% if "C" not in output_formats %}disabled{% endif %}
                    >
                    <label class="form-check-label text-white" for="categorical">
                      Categorical
                    </label>
                  </div>
                  <div class="form-check">
                    <input 
                    class="form-check-input" 
                    type="radio" 
                    name="outputFormat" 
                    id="quantitative" 
                    value="Q" 
                    {% if "Q" not in output_formats %}disabled{% endif %}
                    >
                    <label class="form-check-label text-white" for="quantitative">
                      Quantitative
                    </label>
                  </div>

                  <hr style="color:white;">

                  <center>
                  </center>
      </div>
    </div>
  </div>

  <div class="vis-content d-flex flex-column flex-shrink-0 p-3 bg-light">
    <div id="geocode-div">
      <b><label for="geocode" style="padding-bottom: 5px;">{% trans "Select a city:" %}</label></b>
      <br>
      <select name="geocode" style="width: 20%;"  id="geocode">
      </select>
    </div>

    <div class="prediction-search-div">
      <center>
        <center>
          <label for="predictionSearch">{% trans "Select Predictions" %}</label>
        </center>
        <select id="predictionSearch" style="width: 50%;" multiple>
          {% for key, value in predictions.items %}
          <option value="{{ key }}" data-metadata={{value}}>{{ value }}</option>
          {% endfor %}
        </select>
      </center>
    </div>

    <br>

    <iframe id="lineChart" src="{% url 'line_charts' %}{{line_charts_default_uri}}" width="100%" height="500" frameborder="0"></iframe>
  </div>

</div>


<style>

.vis-sidebar {
  width: 280px;
  min-height: calc(100vh - 211px);
}

.vis-content {
  flex-grow: 1;
  min-height: calc(100vh - 211px);
}

.vis-content iframe {
  min-height: calc(100vh - 211px);
}

.btn-primary,
.btn-primary:hover,
.btn-primary:active,
.btn-primary:visited,
.btn-primary:focus {
  background-color: #6875F7 !important; 
  color: white !important;
  border-color: #111111 !important;
}
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
<script>
  $(document).ready(function () {
    $('#predictionSearch').select2({
      placeholder: 'Search',
      allowClear: false,
      closeOnSelect: true,
    });

    $('#geocode').select2({
      placeholder: 'Nothing Selected',
      allowClear: true,
      closeOnSelect: true,
    });

    $('#predictionSearch').val([]).trigger('change');

    const DISEASES = {
      "dengue": "01",
      "zika": "02",
      "chik": "03"
    };

    const TIME_RESOLUTIONS = {
      "day": "D",
      "week": "W",
      "month": "M",
      "year": "Y",
    };

    const ADM_LEVELS = {
      0: "NA",
      1: "ST",
      2: "MU",
      3: "SM",
    };

    function clearSelectors() {
      selectedDisease = null;
      selectedPredictions = [];
      selectedTimeResolution = null;
      selectedAdmLevel = null;
      selectedSpatial = null;
      selectedTemporal = null;
      selectedOutputFormat = null;
      selectedGeocode = null;

      document.getElementById("geocode-div").style.display = "none";

      $("#dengue, #zika, #chik").prop("checked", false);

      $("#day, #week, #month, #year").prop("checked", false);

      admLevel.forEach(level => {
        level.checked = false;
      });

      spatial.indeterminate = true;

      temporal.indeterminate = true;

      outputFormat.forEach(format => {
        format.checked = false;
      });

      updatePredictions(initialPredictions);
    }

    $('#predictionSearch').on('select2:unselect', function (e) {
      selectedPredictions = $(this).val()
      if (selectedPredictions.length === 0) {
        clearSelectors()
      }
    });

    var diseases = document.querySelectorAll('input[name="diseaseRadio"]');
    var timeRes = document.querySelectorAll('input[name="timeResRadio"]');
    var admLevel = document.querySelectorAll('input[name="admLevelRadio"]');
    var spatial = document.getElementById("spatialType");
    var temporal = document.getElementById("temporalType");
    var outputFormat = document.querySelectorAll('input[name="outputFormat"]');
    let selectedDisease = null;
    let selectedTimeResolution = null;
    let selectedAdmLevel = null;
    let selectedSpatial = null;
    let selectedTemporal = null;
    let selectedOutputFormat = null;
    let selectedGeocode = null;

    var selectedPredictions = [];

    if (!selectedSpatial) {
      spatial.indeterminate = true;
    }

    if (!selectedTemporal) {
      temporal.indeterminate = true;
    }

    const initialPredictions = [
      {% for key, value in predictions.items %}
      "{{ value }}",
      {% endfor %}
    ];

    const initialPredictionsMap = {
      {% for key, value in predictions.items %}
      "{{ key }}": "{{ value }}",
      {% endfor %}
    };

    if (String(selectedAdmLevel) === "2") {
      document.getElementById("geocode-div").style.display = "block";
      updateGeocodes(initialPredictions);
    } else {
      document.getElementById("geocode-div").style.display = "none";
    }

    diseases.forEach(function (disease) {
      disease.addEventListener("change", function () {
        selectedDisease = this.id;
        var filteredPredictions = filterPredictions(
          initialPredictions,
          selectedDisease,
          selectedTimeResolution,
          selectedAdmLevel,
          selectedSpatial,
          selectedTemporal,
          selectedOutputFormat,
          selectedGeocode,
        );

        if (String(selectedAdmLevel) === "2") {
          updateGeocodes(filteredPredictions);
        }

        console.log(filteredPredictions);
        console.log(selectedDisease);
        console.log(selectedTimeResolution);
        console.log(selectedAdmLevel);
        console.log(selectedSpatial);
        console.log(selectedTemporal);
        console.log(selectedOutputFormat);
        console.log(selectedGeocode);

        updatePredictions(filteredPredictions, selectedPredictions);
        $('#predictionSearch').val([]).trigger('change');
      });
    });

    timeRes.forEach(function (time) {
      time.addEventListener("change", function () {
        selectedTimeResolution = this.id;
        var filteredPredictions = filterPredictions(
          initialPredictions,
          selectedDisease,
          selectedTimeResolution,
          selectedAdmLevel,
          selectedSpatial,
          selectedTemporal,
          selectedOutputFormat,
          selectedGeocode,
        );

        if (String(selectedAdmLevel) === "2") {
          updateGeocodes(filteredPredictions);
        }

        updatePredictions(filteredPredictions, selectedPredictions);
      });
    });

    admLevel.forEach(function (level) {
      level.addEventListener("change", function () {
        selectedAdmLevel = this.value;
        if (String(selectedAdmLevel) === "2") {
          document.getElementById("geocode-div").style.display = "block";
        } else {
          document.getElementById("geocode-div").style.display = "none";
        }
        var filteredPredictions = filterPredictions(
          initialPredictions,
          selectedDisease,
          selectedTimeResolution,
          selectedAdmLevel,
          selectedSpatial,
          selectedTemporal,
          selectedOutputFormat,
          selectedGeocode,
        );

        if (String(selectedAdmLevel) === "2") {
          updateGeocodes(filteredPredictions);
        }

        updatePredictions(filteredPredictions, selectedPredictions);
      });
    });

    spatial.addEventListener("change", function() {
      selectedSpatial = this.checked;
      var filteredPredictions = filterPredictions(
        initialPredictions,
        selectedDisease,
        selectedTimeResolution,
        selectedAdmLevel,
        selectedSpatial,
        selectedTemporal,
        selectedOutputFormat,
        selectedGeocode,
      );

      if (String(selectedAdmLevel) === "2") {
        updateGeocodes(filteredPredictions);
      }

      updatePredictions(filteredPredictions, selectedPredictions);
    });

    temporal.addEventListener("change", function() {
      selectedTemporal = this.checked;
      var filteredPredictions = filterPredictions(
        initialPredictions,
        selectedDisease,
        selectedTimeResolution,
        selectedAdmLevel,
        selectedSpatial,
        selectedTemporal,
        selectedOutputFormat,
        selectedGeocode,
      );

      if (String(selectedAdmLevel) === "2") {
        updateGeocodes(filteredPredictions);
      }

      updatePredictions(filteredPredictions, selectedPredictions);
    });

    outputFormat.forEach(function (format) {
      format.addEventListener("change", function () {
        selectedOutputFormat = this.value;
        var filteredPredictions = filterPredictions(
          initialPredictions,
          selectedDisease,
          selectedTimeResolution,
          selectedAdmLevel,
          selectedSpatial,
          selectedTemporal,
          selectedOutputFormat,
          selectedGeocode,
        );

        if (String(selectedAdmLevel) === "2") {
          updateGeocodes(filteredPredictions);
        }

        updatePredictions(filteredPredictions, selectedPredictions);
      });
    });

    $('#geocode').on("change", function () {
      let geocode = $(this).val();
      if (geocode) {
        selectedGeocode = geocode;
      }

      var filteredPredictions = filterPredictions(
        initialPredictions,
        selectedDisease,
        selectedTimeResolution,
        selectedAdmLevel,
        selectedSpatial,
        selectedTemporal,
        selectedOutputFormat,
        selectedGeocode,
      );

      updatePredictions(filteredPredictions, selectedPredictions);
    });

    $('#predictionSearch').on("change", function () {
      selectedPredictions = $(this).val();
      console.log(selectedPredictions);

      selectedPredictions.forEach(predictionId => {
        if (predictionId) {
          prediction = initialPredictionsMap[predictionId];

          if (prediction.startsWith("01")) {
            selectedDisease = "dengue";
            $("#predictionSearch option:not([data-metadata^='01'])").prop("disabled", true).appendTo("#predictionSearch");
            $("#dengue").prop("checked", true);
          } else if (prediction.startsWith("02")) {
            selectedDisease = "zika";
            $("#predictionSearch option:not([data-metadata^='02'])").prop("disabled", true).appendTo("#predictionSearch");
            $("#zika").prop("checked", true);
          } else if (prediction.startsWith("03")) {
            selectedDisease = "chik";
            $("#predictionSearch option:not([data-metadata^='03'])").prop("disabled", true).appendTo("#predictionSearch");
            $("#chik").prop("checked", true);
          }

          if (prediction.charAt(2) === "D") {
            selectedTimeResolution = "day";
            $("#predictionSearch option").filter(function() {
              var timeRes = $(this).text().charAt(2);
              return timeRes !== "D";
            }).prop("disabled", true).appendTo("#predictionSearch");
            $("#day").prop("checked", true);
          } else if (prediction.charAt(2) === "W") {
            selectedTimeResolution = "week";
            $("#predictionSearch option").filter(function() {
              var timeRes = $(this).text().charAt(2);
              return timeRes !== "W";
            }).prop("disabled", true).appendTo("#predictionSearch");
            $("#week").prop("checked", true);
          } else if (prediction.charAt(2) === "M") {
            selectedTimeResolution = "month";
            $("#predictionSearch option").filter(function() {
              var timeRes = $(this).text().charAt(2);
              return timeRes !== "M";
            }).prop("disabled", true).appendTo("#predictionSearch");
            $("#month").prop("checked", true);
          } else if (prediction.charAt(2) === "Y") {
            selectedTimeResolution = "year";
            $("#predictionSearch option").filter(function() {
              var timeRes = $(this).text().charAt(2);
              return timeRes !== "Y";
            }).prop("disabled", true).appendTo("#predictionSearch");

            $("#year").prop("checked", true);
          }

          if (prediction.substr(3, 2) === "NA") {
            selectedAdmLevel = 0;
            selectedGeocode = null;
            document.getElementById("geocode-div").style.display = "none";
            $("#predictionSearch option").filter(function() {
              var admLevel = $(this).text().substr(3, 2);
              return admLevel !== "NA";
            }).prop("disabled", true).appendTo("#predictionSearch");
            $("#national").prop("checked", true);
          } else if (prediction.substr(3, 2) === "ST") {
            selectedAdmLevel = 1;
            selectedGeocode = null;
            document.getElementById("geocode-div").style.display = "none";
            $("#predictionSearch option").filter(function() {
              var admLevel = $(this).text().substr(3, 2);
              return admLevel !== "ST";
            }).prop("disabled", true).appendTo("#predictionSearch");
            $("#state").prop("checked", true);
          } else if (prediction.substr(3, 2) === "MU") {
            document.getElementById("geocode-div").style.display = "block";
            selectedAdmLevel = 2;
            selectedGeocode = prediction.substr(10, 7);
            $("#predictionSearch option").filter(function() {
              let geocode = $(this).text().substr(10, 7);
              var admLevel = $(this).text().substr(3, 2);
              return ((admLevel !== "MU") && (geocode !== selectedGeocode));
            }).prop("disabled", true).appendTo("#predictionSearch");
            $("#municipal").prop("checked", true);
            // $("#geocode").val(selectedGeocode).trigger("change");
          } else if (prediction.substr(3, 2) === "SM") {
            selectedAdmLevel = 3;
            selectedGeocode = null;
            document.getElementById("geocode-div").style.display = "none";
            $("#predictionSearch option").filter(function() {
              var admLevel = $(this).text().substr(3, 2);
              return (admLevel !== "SM");
            }).prop("disabled", true).appendTo("#predictionSearch");
            $("#submunicipal").prop("checked", true);
          }

        }
      })

      // updateLineChart(selectedPredictions);
    });

    function updateGeocodes(predictions) {
      $('#geocode').empty();

      const extractedGeocodes = predictions.map(prediction => {
        const parts = prediction.split('-');
        return parts[2];
      });

      const geocodes = [...new Set(extractedGeocodes)];

      geocodes.forEach(geocode => {
        var opt = document.createElement('option');
        opt.value = geocode;
        opt.innerHTML = geocode;
        $("#geocode").append(opt).selectpicker('refresh');
      });

      $("#geocode").prop("selectedIndex", -1);
      $('#geocode').selectpicker('refresh');
    };

    function updatePredictions(predictions, selectedPredict = []) {
      let selectedPredictMetadata = selectedPredict ? selectedPredict.map(id => initialPredictionsMap[id]) : [];
      $("#predictionSearch option").each(function () {
        const metadata = $(this).data("metadata");
        if (!selectedPredictMetadata.includes(metadata)) {
          if (predictions.includes(metadata)) {
            $(this).prop("disabled", false);
          } else {
            $(this).prop("disabled", true);
            $(this).detach().appendTo("#predictionSearch");
          }
        }
      });
    };

    function updateLineChart(selectedPredictIds = null) {
      var lineChartIframe = $('#lineChart');
      var lineChartUrl = '{% url "line_charts" %}?';

      if (selectedPredictIds !== null) {
        selectedPredictIds = selectedPredictIds.filter(function(predictId) {
          return predictId !== null;
        });

        if (selectedPredictIds.length > 0) {
          selectedPredictIds.forEach(function(predictId) {
            if (predictId != false) {
              lineChartUrl += 'predict=' + predictId + '&';
            }
          });

          lineChartUrl = lineChartUrl.slice(0, -1);
        }
      }

      lineChartIframe.attr('src', lineChartUrl);
    }

    function filterPredictions(
      predictions, 
      disease, 
      timeResolution, 
      admLevel, 
      spatial,
      temporal, 
      quantitative, 
      geocode
    ) {
      return predictions.filter(hash => {
        if (disease != null && !hash.startsWith(DISEASES[disease])) {
          return false;
        }

        if (timeResolution != null && hash.charAt(2) !== TIME_RESOLUTIONS[timeResolution]) {
          return false;
        }

        if (admLevel != null && hash.substr(3, 2) !== ADM_LEVELS[admLevel]) {
          return false;
        }

        if (spatial != null) {
          if ((spatial && hash.charAt(6) === "0") || (!spatial && hash.charAt(6) === "1")) {
            return false;
          }
        }

        if (temporal != null) {
          if ((temporal && hash.charAt(7) === "0") || (!temporal && hash.charAt(7) === "1")) {
            return false;
          }
        }

        if (quantitative != null) {
          if (
            (quantitative === "C" && hash.charAt(8) !== "C") || 
            (quantitative === "Q" && hash.charAt(8) !== "Q")
          ) {
            return false;
          }
        }

        if (geocode != null) {
          if (hash.substr(10, 7) !== geocode) {
            return false;
          }
        }

        return true;
      });
    }
  });

</script>
{% endblock %}
