{% extends 'main/base.html' %}
{% load i18n %}
{% load plotly_dash %}
{% load filters %}

{% block title %}{% translate "Visualization" %}{% endblock %}

{% block content %}
<div style="display:flex;">
    <div class="vis-sidebar d-flex flex-column flex-shrink-0 bg-dark">
        <div class="sidebar-menu">
            <div class="p-3">
                <center><b>
                    <label for="diseaseRadio" class="text-white">{% trans "Disease" %}</label>
                </b></center>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="diseaseRadio" 
                  id="dengue"
                  {% if "dengue" not in diseases %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="dengue">Dengue</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="diseaseRadio" 
                  id="zika"
                  {% if "zika" not in diseases %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="zika">Zika</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="diseaseRadio" 
                  id="chik"
                  {% if "chikungunya" not in diseases %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="chik">Chikungunya</label>
                </div>

                <hr style="color:white;">

                <center><b>
                    <label for="timeResRadio" class="text-white">{% trans "Temporal Resolution" %}</label>
                </b></center>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="timeResRadio" 
                  id="day"
                  {% if "day" not in time_resolutions %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="day">Daily</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="timeResRadio" 
                  id="week"
                  {% if "week" not in time_resolutions %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="week">Weekly</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="timeResRadio" 
                  id="month"
                  {% if "month" not in time_resolutions %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="month">Monthly</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="timeResRadio" 
                  id="year"
                  {% if "year" not in time_resolutions %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="year">Yearly</label>
                </div>

                <hr style="color:white;">

                <center><b>
                    <label for="admLevelRadio" class="text-white">{% trans "Administrative Level" %}</label>
                </b></center>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="admLevelRadio" 
                  id="national"
                  value=0
                  {% if 0 not in adm_levels %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="national">National</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="admLevelRadio" 
                  id="state"
                  value=1
                  {% if 1 not in adm_levels %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="state">State</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="admLevelRadio" 
                  id="municipal"
                  value=2
                  {% if 2 not in adm_levels %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="municipal">Municipal</label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="admLevelRadio" 
                  id="submunicipal"
                  value=3
                  {% if 3 not in adm_levels %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="submunicipal">Sub Municipal</label>
                </div>

                <hr style="color:white;">

                <center><b>
                    <label for="modelType" class="text-white">{% trans "Model Type" %}</label>
                </b></center>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="checkbox" 
                  value="" 
                  id="spatialType" 
                  {% if "spatial" not in model_types %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="spatialType">
                    Spatial
                  </label>
                </div>
                <div class="form-check">
                  <input
                  class="form-check-input" 
                  type="checkbox" 
                  value="" 
                  id="temporalType" 
                  {% if "temporal" not in model_types %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="temporalType">
                    Temporal
                  </label>
                </div>

                <hr style="color:white;">

                <center><b>
                    <label for="outputFormat" class="text-white">{% trans "Output Format" %}</label>
                </b></center>
                <div class="form-check">
                  <input
                  class="form-check-input" 
                  type="radio" 
                  name="outputFormat" 
                  id="categorical" 
                  value="C" 
                  {% if "C" not in output_formats %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="categorical">
                    Categorical
                  </label>
                </div>
                <div class="form-check">
                  <input 
                  class="form-check-input" 
                  type="radio" 
                  name="outputFormat" 
                  id="quantitative" 
                  value="Q" 
                  {% if "Q" not in output_formats %}disabled{% endif %}
                  >
                  <label class="form-check-label text-white" for="quantitative">
                    Quantitative
                  </label>
                </div>

                <hr style="color:white;">

                <center>
                    <div id="geocode-div">
                        <label for="geocode" class="text-white">{% trans "Geocode" %}</label>
                        <select name="geocode" id="geocode" class="selectpicker" data-size="5" data-live-search="true">
                        </select>

                        <hr style="color:white;">
                    </div>
                </center>

                <center>
                    <label for="predictions" class="text-white">{% trans "Predictions" %}:</label>
                    <select name="predictions" id="predictions" class="selectpicker" data-size="7" multiple>
                    </select>
                </center>

            </div>
        </div>
    </div>

    <div class="vis-content d-flex flex-column flex-shrink-0 p-3 bg-light">
        <label for="hashSearch">Search: </label>
        <input type="text" id="predictionSearch" placeholder="Search for Predictions">

        <select id="hashList">
          {% for key, value in predictions.items %}
            <option value="{{ key }}">{{ value }}</option>
          {% endfor %}
        </select>

        <iframe id="lineChart" src="{% url 'line_charts' %}{{line_charts_default_uri}}" width="100%" height="500" frameborder="0"></iframe>
        {% for k, v in predictions.items %}
            {{v}}
            <br>
        {% endfor %}
    </div>

</div>


<style>

.vis-sidebar {
    width: 280px;
    min-height: calc(100vh - 211px);
}

.vis-content {
    flex-grow: 1;
    min-height: calc(100vh - 211px);
}

.vis-content iframe {
    min-height: calc(100vh - 211px);
}

.btn-primary,
.btn-primary:hover,
.btn-primary:active,
.btn-primary:visited,
.btn-primary:focus {
    background-color: #6875F7 !important; 
    color: white !important;
    border-color: #111111 !important;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        const initialList = [
            {% for key, value in predictions.items %}
                { name: "{{ value }}", value: "{{ key }}" },
            {% endfor %}
        ];

        const hashList = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            local: initialList
        });

        $('#hashSearch').typeahead({
            hint: true,
            highlight: true,
            minLength: 1
        },
        {
            name: 'hashList',
            display: 'name',
            source: hashList
        });

        $('#hashSearch').on('typeahead:select', function(event, suggestion) {
            $('#hashSelect').val(suggestion.value);
        });

        const DISEASES = {
            "dengue": "01",
            "zika": "02",
            "chik": "03"
        };

        const TIME_RESOLUTIONS = {
            "day": "D",
            "week": "W",
            "month": "M",
            "year": "Y",
        };

        const ADM_LEVELS = {
            0: "NA",
            1: "ST",
            2: "MU",
            3: "SM",
        };

        var diseases = document.querySelectorAll('input[name="diseaseRadio"]');
        var timeRes = document.querySelectorAll('input[name="timeResRadio"]');
        var admLevel = document.querySelectorAll('input[name="admLevelRadio"]');
        var spatial = document.getElementById("spatialType");
        var temporal = document.getElementById("temporalType");
        var outputFormat = document.querySelectorAll('input[name="outputFormat"]');
        let selectedDisease = null;
        let selectedTimeResolution = null;
        let selectedAdmLevel = null;
        let selectedSpatial = null;
        let selectedTemporal = null;
        let selectedOutputFormat = null;

        diseases.forEach(function (disease) {
            disease.addEventListener("change", function () {
                selectedDisease = this.id;
                console.log(selectedDisease);
            });
        });

        timeRes.forEach(function (time) {
            time.addEventListener("change", function () {
                selectedTimeResolution = this.id;
                console.log(selectedTimeResolution);
            });
        });

        admLevel.forEach(function (level) {
            level.addEventListener("change", function () {
                console.log(this.value);
            });
        });

        spatial.addEventListener("change", function() {
            console.log(spatial.checked);
        });

        temporal.addEventListener("change", function() {
            console.log(temporal.checked);
        });

        outputFormat.forEach(function (format) {
            format.addEventListener("change", function () {
                console.log(this.value);
            });
        });

        function filterPredictions(predictions, disease, timeResolution, admLevel, spatial, temporal, quantitative) {
            return predictions.filter(hash => {
                if (disease && !hash.startsWith(DISEASES[disease])) {
                    return false;
                }

                if (timeResolution && hash.charAt(2) !== TIME_RESOLUTIONS[timeResolution]) {
                    return false;
                }

                if (admLevel && hash.substr(3, 2) !== ADM_LEVELS[admLevel]) {
                    return false;
                }

                if (spatial !== undefined) {
                    if (spatial && hash.charAt(6) === "0") {
                        return false;
                    } else if (!spatial && hash.charAt(6) === "1") {
                        return false;
                    }
                }

                if (temporal !== undefined) {
                    if (temporal && hash.charAt(7) === "0") {
                        return false;
                    } else if (!temporal && hash.charAt(7) === "1") {
                        return false;
                    }
                }

                if (quantitative !== undefined) {
                    if (quantitative && hash.charAt(8) === "C") {
                        return false;
                    } else if (!quantitative && hash.charAt(8) === "Q") {
                        return false;
                    }
                }

                return true;
            });
        }
    });

</script>
{% endblock %}
