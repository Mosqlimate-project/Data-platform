{% extends 'main/base.html' %}
{% load i18n %}
{% load plotly_dash %}
{% load static %}
{% load filters %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/vis/dashboard/index.css' %}">
<input type="hidden" id="dashboardsEl" value='{{ dashboards|parse_nones|safe }}'>

<script>
const dashboardsEl = document.getElementById('dashboardsEl');
let dashboards = JSON.parse(dashboardsEl.value);
let dashboard = `{{ dashboard }}`;
let local = null;

function dashboardsDataGetter(dashboard) {
  const dashboards = JSON.parse(dashboardsEl.value);
  return dashboards[dashboard];
}

function dashboardsQuerySetter(dashboard, queryKey, queryValue) {
  const dashboardsPrev = dashboardsEl.value;

  dashboards[dashboard].query[queryKey] = queryValue;

  const dashboardsNew = JSON.stringify(dashboards);

  if (dashboardsPrev !== dashboardsNew) {
    dashboardsEl.value = dashboardsNew;
    dashboardsEl.dispatchEvent(new Event('change'));
  }
}

dashboardsEl.addEventListener('change', () => {
  console.log("change");
  console.log(JSON.parse(dashboardsEl.value));
  Object.keys(dashboards).forEach(dashboard => {
    getAdm1MenuOptions(dashboard);
  });
});

function updateContentState() {
  const dsContent = document.getElementById('dsContent'); 
  if (!menu.classList.contains('retracted')) {
    dsContent.classList.add('expanded');
    dsContent.classList.remove('retracted');
  } else {
    dsContent.classList.add('retracted');
    dsContent.classList.remove('expanded');
  }
}

function changeContent(selectedDashboard) {
  Object.keys(dashboards).forEach(dashboard => {
    const contentDiv = document.getElementById(`dsContent-${dashboard}`);
    if (contentDiv) {
      contentDiv.classList.add('hidden');
    }
  });

  const contentDiv = document.getElementById(`dsContent-${selectedDashboard}`);
  if (contentDiv) {
    contentDiv.classList.remove('hidden');
  }
}

async function getBrowserCity() {
  try {
    const ipApi = await fetch('http://ip-api.com/json');
    const loc = await ipApi.json();

    if (loc.countryCode === 'BR') {
      const uf = loc.region;
      const city = loc.city;

      if (uf && city) {
        const cityInfoResponse = await fetch(`/vis/ibge/city/?name=${encodeURIComponent(city)}&uf=${encodeURIComponent(uf)}`);
        const cityInfo = await cityInfoResponse.json();

        if (cityInfo.geocode) {
          return cityInfo;
        } else {
          return null;
        }
      } else {
        return null;
      }
    }
  } catch (error) {
    return null;
  }
  return null;
}
</script>


{% include 'vis/dashboard/menu.html' %}
<div id="dsContent" class="container shadow">
{% for name, data in dashboards.items %}
  <div id="dsContent-{{name}}">
  {{name}}
  </div>
{% endfor %}
</div>


<script>
const observer2 = new MutationObserver(function (mutationsList) {
  mutationsList.forEach(function (mutation) {
    if (mutation.attributeName === 'class') {
      updateContentState();
    }
  });
});

document.addEventListener('DOMContentLoaded', function() {
  updateContentState();
  changeContent(dashboard);
  observer2.observe(menu, { attributes: true });
});
</script>

{% endblock %}
