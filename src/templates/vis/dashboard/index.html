{% extends 'main/base.html' %}
{% load i18n %}
{% load plotly_dash %}
{% load static %}
{% load filters %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/vis/dashboard/index.css' %}">

<script>
const dashboards = {{ dashboards|parse_nones|safe }};
let dashboard = `{{ dashboard }}`;

function updateContentState() {
  const dsContent = document.getElementById('dsContent'); 
  if (!menu.classList.contains('retracted')) {
    dsContent.classList.add('expanded');
    dsContent.classList.remove('retracted');
  } else {
    dsContent.classList.add('retracted');
    dsContent.classList.remove('expanded');
  }
}

function changeContent(selectedDashboard) {
  Object.keys(dashboards).forEach(dashboard => {
    const contentDiv = document.getElementById(`dsContent-${dashboard}`);
    if (contentDiv) {
      contentDiv.classList.add('hidden');
    }
  });

  const contentDiv = document.getElementById(`dsContent-${selectedDashboard}`);
  if (contentDiv) {
    contentDiv.classList.remove('hidden');
  }
}
</script>

{% include 'vis/dashboard/menu.html' %}
<div id="dsContent" class="container shadow">
{% for name, data in dashboards.items %}
  <div id="dsContent-{{name}}">
  {{name}}
  </div>
{% endfor %}
</div>

<script>
const observer2 = new MutationObserver(function (mutationsList) {
  mutationsList.forEach(function (mutation) {
    if (mutation.attributeName === 'class') {
      updateContentState();
    }
  });
});

async function getBrowserCity() {
  try {
    const ipApi = await fetch('http://ip-api.com/json');
    const location = await ipApi.json();

    if (location.countryCode === 'BR') {
      const uf = location.region;
      const city = location.city;

      if (uf && city) {
        const cityInfoResponse = await fetch(`/vis/ibge/city/?name=${encodeURIComponent(city)}&uf=${encodeURIComponent(uf)}`);
        const cityInfo = await cityInfoResponse.json();

        if (cityInfo.geocode) {
          return cityInfo;
        } else {
          return null;
        }
      } else {
        return null;
      }
    }
  } catch (error) {
    console.error('Error fetching geocode:', error);
    return null;
  }
  return null;
}

getBrowserCity().then(geocode => {
  console.log(geocode);
});

document.addEventListener('DOMContentLoaded', function() {
  updateContentState();
  changeContent(dashboard);
  observer2.observe(menu, { attributes: true });
});
</script>

{% endblock %}
