{% extends 'vis/dashboard/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}Dashboard - Predictions{% endblock %}

{% block content %}
<div id="adm-select-card" class="card collapse show">
  <div class="card-body">
    {% if dashboard != "sprint" %}
    <div class="mb-2 text-center">
      <div class="btn-group" role="group" aria-label="ADM Level">
        <button type="button" class="btn btn-sm btn-primary" id="toggle-state">{% trans "Statewide" %}</button>
        <button type="button" class="btn btn-sm btn-outline-primary" id="toggle-city">{% trans "Municipal" %}</button>
      </div>
    </div>
    {% endif %}

    <div id=params-select class="row gy-3">
      <div id="disease-select" class="col-3">
        <div class="d-flex flex-column">
          <span class="text-muted mb-1">{% trans "Disease:" %}</span>
          <select id="disease-filter" class="form-select form-select-sm" style="text-transform:capitalize;"></select>
        </div>
      </div>
      <div id="adm0-select" class="col">
        <div class="d-flex flex-column">
          <span class="text-muted mb-1">{% trans "Country" %}:</span>
          <select id="adm0-filter" class="form-select form-select-sm"></select>
        </div>
      </div>
      <div id="adm1-select" class="col-3">
        <div class="d-flex flex-column">
          <span class="text-muted mb-1">{% trans "State" %}:</span>
          <select id="adm1-filter" class="form-select form-select-sm"></select>
        </div>
      </div>
      <div id="adm2-select" class="col">
        <div class="d-flex flex-column">
          <span class="text-muted mb-1">{% trans "Municipality" %}:</span>
          <select id="adm2-filter" class="form-select form-select-sm"></select>
        </div>
      </div>
      <div id="adm3-select" class="col">
        <div class="d-flex flex-column">
          <span class="text-muted mb-1">{% trans "Sub-Municipality" %}:</span>
          <select id="adm3-filter" class="form-select form-select-sm"></select>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div id="chart-card" class="card-body">
    <i id="infoModalIcon" class="fas fa-question-circle text-muted" data-bs-toggle="modal" data-bs-target="#infoModal" title={% trans "More info" %}></i>
    <div id="chart" style="height: 100%; width: 100%; min-height: 350px"></div>
  </div>
</div>

<div class="row">
  <div id="models-col" class="col-1">
    <div id="models-card" class="card collapsed">
      <div class="card-header">
        <h3 class="card-title">{% trans "Models" %}</h3>
        <div class="card-tools ms-auto">
          <div id="search" class="input-group input-group-sm" style="width: 200px;">
            <input type="text" name="models-search" class="form-control float-right" placeholder='{% trans "Search" %}'>
            <div class="input-group-append">
              <button type="submit" class="btn btn-default">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <button type="button" class="btn btn-tool toggle-models">
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        <table id="models-list" class="table table-bordered table-hover"></table>
      </div>
    </div>
  </div>

  <div class="col">
    <div id="predictions-card" class="card">
      <div class="card-header">
        <h3 class="card-title">{% trans "Predictions" %}</h3>
      </div>
      <div class="card-body" style="margin:0;padding:0;">
        <table id="predictions-list" class="table table-bordered table-hover"></table>
      </div>
      <div class="card-footer clearfix">
        <div class="row">
          <div class="col">
            <button id="predictions-clear-all" type="button" class="btn btn-tool">{% trans "Clear" %}</button>
          </div>
          <div class="col">
            <ul id="predictions-pagination" class="pagination pagination-sm m-0 float-right"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<br>
<br>
<br>

<div class="modal fade" id="infoModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">{% trans "Welcome to Mosqlimate Predictions Dashboard" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div>
          <p class="fs-6 fw-bold">{% trans "Confidence Interval" %}</p>
          {% trans "To toggle the Prediction's Confidence Interval bounds of the in the chart, click in the Prediction's legend" %}
          <img src="{% static 'img/vis/prediction-dashboard-show-boundaries.png' %}">
          {% trans " or line" %}
          <img src="{% static 'img/vis/prediction-dashboard-show-boundaries-2.png' %}">
        </div>
        <br>
        <div>
          <p class="fs-6 fw-bold">{% trans "Interval Bounds" %}</p>
          <p>{% trans "When the Confidence Interval is active, the Prediction will display the 50% and 90% bounds (upper and lower)" %}</p>
          <img src="{% static 'img/vis/prediction-bounds-example.png' %}" style="width: 470px">
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="scoresModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">{% trans "Scores" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>{% trans "Forecast scores are metrics that quantify how well probabilistic or point forecasts match the observed outcomes" %}</p>
        <br>
        <div>
          <p class="fs-6 fw-bold">MAE</p>
          <p>{% trans "Measures the average magnitude of the errors in the predictions. Lower values mean predictions are closer on average to actual data" %}</p>
        </div>
        <br>
        <div>
          <p class="fs-6 fw-bold">MSE</p>
          <p>{% trans "Measures the average of the squared differences between forecast and observation. Lower values mean fewer and/or smaller large errors in predictions" %}</p>
        </div>
        <br>
        <div>
          <p class="fs-6 fw-bold">{% trans "Continuous Ranked Probability Score (CRPS)" %}</p>
          <p>{% trans "Evaluate how well the predicted cumulative distribution function (CDF) matches the observed outcome. The prediction is modeled as a log-normal distribution for this calculation. The CRPS generalizes the Mean Absolute Error (MAE) to probabilistic forecasts. Lower CRPS values indicate better predictive performance." %}</p>
        </div>
        <br>
        <div>
          <p class="fs-6 fw-bold">Log Score</p>
          <p>{% trans "Measures the log-probability assigned to the observed value by the forecast distribution. The prediction is modeled as a log-normal distribution for this calculation. Larger log score values indicate better predictive performance." %}</p>
        </div>
        <br>
        <div>
          <p class="fs-6 fw-bold">Interval Score</p>
          <p>{% trans "Evaluates prediction intervals (e.g., 90% confidence intervals) of the forecast. The interval score penalizes forecasts when the observed value falls outside the predicted interval and favors narrower intervals when the observation is within the range. Lower values indicate better predictive performance." %}</p>
        </div>
        <br>
        <div>
          <p class="fs-6 fw-bold">{% trans "Weighted Interval Score (WIS)" %}</p>
          <p>{% trans "The WIS is a metric that combines multiple interval scores and serves as an approximation of the CRPS when forecasts are provided in the form of quantiles. Lower values indicate better predictive performance." %}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="{% static 'js/external/jquery.js' %}"></script>
<script>
  const dashboard = `{{ dashboard }}`;

  {% if prediction %}
  const prediction = {{ prediction|safe }};
  {% else %}
  const prediction = null;
  {% endif %}

  const diseases = {{ diseases|safe }};
  const adm_list = {{ adm_list|safe }};
  const min_window_date = `{{ min_window_date }}`;
  const max_window_date = `{{ max_window_date }}`;
  const watermark = `{% static 'img/logo-mosqlimate.png' %}`
  const loading = `{% static 'img/loading-dots.gif' %}`

  let sidebar_collapsed_once = false;

$('.toggle-models').on('click', function () {
  const col = $('#models-col');
  const card = $('#models-card');

  card.toggleClass('collapsed');

  if (card.hasClass('collapsed')) {
    col.removeClass('col-4').addClass('col-1');
    $(this).find('i').removeClass('fa-minus').addClass('fa-plus');
  } else {
    if (!sidebar_collapsed_once) {
      $('[data-widget="pushmenu"]').click();
      sidebar_collapsed_once = true;
    }
    col.removeClass('col-1').addClass('col-4');
    $(this).find('i').removeClass('fa-plus').addClass('fa-minus');
  }
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

<style>
#models-card .card-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#models-card .card-tools {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

#models-card .card-header {
  padding-right: 0;
  transition: padding-left 0.3s ease;
}

#models-card.collapsed .card-body {
  display: none;
}

#models-card.collapsed #search {
  display: none;
}

#models-card.collapsed .card-title {
  font-size: 0.85rem;
  transition: font-size 0.3s ease;
}

#models-card.collapsed .card-header {
  padding-left: 4px;
  transition: padding-left 0.3s ease;
}

#infoModalIcon {
  position: absolute;
  left: calc(100% - 30px);
  top: 15px;
  z-index: 50;
}

.table {
  table-layout: fixed;
}

#scores {
  height: 25px;
  font-size: 0.75rem;
}

.truncate-name {
  max-width: 150px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card-tools {
  height: 20px;
}

@keyframes float {
	0% {
		transform: translateX(-50%) translatey(0px);
	}
	50% {
		transform: translateX(-50%) translatey(-6px);
	}
	100% {
		transform: translateX(-50%) translatey(0px);
	}
}

.loading-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255, 255, 255, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.loading-overlay.active {
  pointer-events: auto;
  opacity: 1;
}

.loading-overlay i {
  font-size: 2rem;
  color: #333;
}

.prediction-row {
  background: transparent; /* default */
  transition: background 0.3s ease;
}

.prediction-row:hover {
  background: linear-gradient(to right, var(--gradient-start), transparent);
}
</style>

<script type="text/javascript" src="{% static 'js/vis/dashboard/lineChart.js' %}"></script>
<script type="text/javascript" src="{% static 'js/vis/dashboard/predictions.js' %}"></script>
{% endblock %}
