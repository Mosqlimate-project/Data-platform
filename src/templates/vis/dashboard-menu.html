{% load i18n %}
{% load static %}

<link rel="stylesheet" href="{% static 'css/main/base.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">
<link href="{% static 'fontawesomefree/css/fontawesome.css' %}" rel="stylesheet" type="text/css">
<link href="{% static 'fontawesomefree/css/brands.css' %}" rel="stylesheet" type="text/css">
<link href="{% static 'fontawesomefree/css/solid.css' %}" rel="stylesheet" type="text/css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">


<div id="menu" class="font-golos d-flex flex-column flex-shrink-0 bg-dark">
  <div id="menuHeader" class="align-items-center">
    <p id="menuTitle" class="menu-txt text-white text-start show">Mosqlimate</p>
    <button id="expandMenu" class="btn menu-btn menu-toggle-btn btn-primary">
      <i class="fa-regular fa-bars rectracted-icon"></i>
    </button>
    <button id="retractMenu" class="btn menu-btn menu-toggle-btn btn-primary">
      <i class="fa-solid fa-caret-down expanded-icon"></i>
    </button>
  </div>

  <hr style="color:white;">

  <div id="dsSelect" class="align-items-center">
    <button id="dsRetracted" class="btn menu-btn ds-toggle-btn btn-primary d-flex align-items-center">
      <i class="fa-regular fa-chart-line me-2"></i>
    </button>
    <button id="dsExpanded" class="btn menu-btn ds-toggle-btn btn-primary d-flex align-items-center">
      <span id="dsTitle" class="menu-txt text-white text-start">Dashboard</span>
      <i class="fa-solid fa-chevron-down"></i>
    </button>
  </div>

  <hr style="color:white;">

  <div>
    <div id="predictDatePicker">
      <input type="text" name="start"><span> - </span><input type="text" name="end">
    </div>
    <br>
    <div id="predictWindowDatePicker">
      <input type="text" name="windowStart"><span> - </span><input type="text" name="windowEnd">
    </div>
  </div>

  <div>
    <div class="p-3">
      <center><b>
        <label for="diseaseRadio" class="text-white">{% trans "Disease" %}</label>
      </b></center>
      <hr style="color:white;">

      <center><b>
        <label for="timeResRadio" class="text-white">{% trans "Temporal Resolution" %}</label>
      </b></center>

      <hr style="color:white;">

      <center><b>
        <label for="admLevelRadio" class="text-white">{% trans "Administrative Level" %}</label>
      </b></center>

      <hr style="color:white;">

      <center><b>
        <label for="outputFormat" class="text-white">{% trans "Output Format" %}</label>
      </b></center>
      <hr style="color:white;">
    </div>
  </div>
</div>

<style>

body {
  margin: 0px;
}

.hidden {
  opacity: 0;
  display: none !important;
  visibility: hidden !important;
}

.visible {
  opacity: 1;
  display: block !important;
  visibility: visible !important;
}

#menu {
  height: 100%;
  padding: 5px;
  transition: all 0.2s ease;
  box-shadow: 2px 0 2px rgba(0, 0, 0, 0.3);
}

#menu hr {
  width: calc(100% + 10px);
  margin-left: -5px;
  margin-right: -5px;
  margin-top: 5px;
  margin-bottom: 5px;
  border: 0;
  border-top: 1px solid #fff;
}

#menu.expanded {
  max-width: 200px;
}

#menu.retracted {
  max-width: 50px;
}

#menuTitle {
  font-size: 20px;
  flex-grow: 1;
  text-align: center;
  overflow: hidden;
  white-space: nowrap;
  max-width: 0;
  opacity: 1;
  margin: 0;
  padding: 0;
  max-height: 0;
  width: 0;
  height: 0;
}

.menu-btn {
  transition: all 0.3s ease;
}

.menu-txt {
  transition: max-width 0.2s ease, opacity 0.2s ease, transform 0.2s ease;
  transform: translateX(0);
  transform-origin: right center;
}

#menu.retracted #menuTitle {
  opacity: 0;
  transform: translateX(-100%);
}

#menuTitle.show {
  max-width: 100%;
  opacity: 1;
  max-height: initial;
  width: auto;
  height: auto;
}

#menuHeader {
  display: flex;
  align-items: center;
}

.menu-toggle-btn {
  opacity: 1;
  visibility: visible;
  flex-shrink: 0;
  width: 40px;
  height: 40px
}

.menu-toggle-btn.hidden {
  opacity: 0;
  visibility: hidden;
}

#dsSelect {
  display: flex;
  align-items: center;
}

#dsRetracted, #dsExpanded {
  transition: none;
}

#dsExpanded {
  display: flex !important;
  justify-content: space-between;
}

.ds-toggle-btn {
  transition: opacity 0.3s ease, visibility 0.3s ease;
  opacity: 1;
  visibility: visible;
  flex-shrink: 0;
  width: 100%;
  height: 40px
}

.fa-chevron-down {
  font-size: 0.75rem;

}

.expanded-icon {
  transform: rotate(90deg);
}


</style>

<script src="{% static 'js/external/jquery.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/locales/pt-BR.js"></script>
<script src="https://cdn.jsdelivr.net/gh/farhadmammadli/bootstrap-select@main/js/bootstrap-select.min.js"></script>

<script>
// Vars
let menuState = "expanded";
let isTransitioning = false;

const useri18n = navigator.language || navigator.userLanguage;
const dateFormat = 'yyyy-mm-dd';

const dashboards = {{ dashboards|safe }};

let startDate = `{{ start_date }}`;
let endDate = `{{ end_date }}`;
let startWindowDate = `{{ start_window_date }}`;
let endWindowDate = `{{ end_window_date }}`;

let disease = `{{ disease }}`;
let timeResolution = `{{ time_resolution }}`;
let outputFormat = `{{ output_format }}`;
let sprint = `{{ sprint }}`;
let admLevel = `{{ adm_level }}`;
let adm0 = `{{ adm_0 }}`;
let adm1 = `{{ adm_1 }}`;
let adm2 = `{{ adm_2 }}`;
let adm3 = `{{ adm_3 }}`;

let modelIds = {{ model_ids }};
let predictionIds = {{ prediction_ids }};


// Elements
const menu = document.getElementById('menu');
const menuTitle = document.getElementById('menuTitle');
const expandMenuBtn = document.getElementById('expandMenu');
const retractMenuBtn = document.getElementById('retractMenu');
const dsRetractedBtn = document.getElementById('dsRetracted');
const dsExpandedBtn = document.getElementById('dsExpanded');


// Functions
function setMenuState() {
  if (window.innerWidth <= 1500) {
    if (!menu.classList.contains('retracted')) {
      menu.classList.remove('expanded');
      menu.classList.add('retracted');
      menuState = "retracted";
    }
  } else if (window.innerWidth >= 1200) {
    if (!menu.classList.contains('expanded')) {
      menu.classList.remove('retracted');
      menu.classList.add('expanded');
      menuState = "expanded";
    }
  }
  updateMenuState();
}

function updateMenuState() {
  if (menuState === "retracted") {
    expandMenuBtn.style.display = 'inline-block';
    retractMenuBtn.style.display = 'none';
    menuTitle.classList.remove('show');
    dsExpandedBtn.classList.add('hidden');
    dsExpandedBtn.classList.remove('visible');
    dsRetractedBtn.classList.add('visible');
    dsRetractedBtn.classList.remove('hidden');
  } else if (menuState === "expanded") {
    expandMenuBtn.style.display = 'none';
    retractMenuBtn.style.display = 'inline-block';
    menuTitle.classList.add('show');
    dsExpandedBtn.classList.add('visible');
    dsExpandedBtn.classList.remove('hidden');
    dsRetractedBtn.classList.add('hidden');
    dsRetractedBtn.classList.remove('visible');
  }
}

function toggleMenu() {
  if (isTransitioning) return;

  isTransitioning = true;

  if (menuState === "retracted") {
    menu.classList.remove('retracted');
    menu.classList.add('expanded');
    menuState = "expanded";
  } else if (menuState === "expanded") {
    menu.classList.remove('expanded');
    menu.classList.add('retracted');
    menuState = "retracted";
  }

  updateMenuState();

  setTimeout(() => {
    isTransitioning = false;
  }, 300);
}

let context = {
  "dashboards": dashboards,
  "sprint": sprint !== `` ? sprint : null,

  "startDate": startDate,
  "endDate": endDate,
  "startWindowDate": startWindowDate !== `` ? startWindowDate : startDate,
  "endWindowDate": endWindowDate !== `` ? endWindowDate : endDate,

  "disease": disease !== `` ? disease : "dengue",
  "timeResolution": timeResolution !== `` ? timeResolution : "week",
  "outputFormat": outputFormat !== `` ? outputFormat : null,

  "admLevel": admLevel !== `` ? admLevel : 2,
  "adm0": adm0 !== `` ? adm0 : null,
  "adm1": adm1 !== `` ? adm1 : null,
  "adm2": adm2 !== `` ? adm2 : null,
  "adm3": adm3 !== `` ? adm3 : null,
}

console.log(context);

expandMenuBtn.style.display = 'none';

$(document).ready(function () {
  const observer = new MutationObserver(function (mutationsList) {
    mutationsList.forEach(function (mutation) {
      if (mutation.attributeName === 'class') {
        updateMenuState();
      }
    });
  });

  observer.observe(menu, { attributes: true });

  setMenuState();

  expandMenuBtn.addEventListener('click', toggleMenu);
  retractMenuBtn.addEventListener('click', toggleMenu);
  window.addEventListener('resize', setMenuState);

  menu.addEventListener('click', function(event) {
    if (menuState === "retracted") {
      toggleMenu();
    }
  });

  try {
    navigator.geolocation.getCurrentPosition(function(location) {
      console.log(location.coords.latitude);
      console.log(location.coords.longitude);
      console.log(location.coords.accuracy);
    });
  } catch {}


  const predictDatePicker = document.getElementById('predictDatePicker');
  const predictDateRangePicker = new DateRangePicker(predictDatePicker, {
    buttonClass: 'btn',
    format: dateFormat,
    clearButton: true,
    language: useri18n,
  }); 

  const predictWindowDatePicker = document.getElementById('predictWindowDatePicker');
  const predictWindowDateRangePicker = new DateRangePicker(predictWindowDatePicker, {
    buttonClass: 'btn',
    format: dateFormat,
    clearButton: true,
    language: useri18n,
  }); 

  predictDatePicker.addEventListener('changeDate', handleDatesChange);
  predictWindowDatePicker.addEventListener('changeDate', handleWindowDatesChange);
  predictDateRangePicker.setDates(
    Datepicker.parseDate(startDate, dateFormat), 
    Datepicker.parseDate(endDate, dateFormat), 
  );
  predictWindowDateRangePicker.setDates(
    Datepicker.parseDate(startDate, dateFormat), 
    Datepicker.parseDate(endDate, dateFormat), 
  );


  function handleDatesChange(event) {
    const [startDate, endDate] = predictDateRangePicker.getDates(dateFormat);
    // console.log(`${startDate} - ${endDate}`);
  }

  function handleWindowDatesChange(event) {
    const [startDate, endDate] = predictWindowDateRangePicker.getDates(dateFormat);
    // console.log(`${startDate} - ${endDate}`);
  }

})
</script>
