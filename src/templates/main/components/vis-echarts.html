<!-- src/templates/main/components/vis-echarts.html -->

{% load static %}

<style>
  /* Add CSS for the floating window */
  .floating-window {
    margin-top: 20px;
    width: 100%;
    height: 800px;
    background-color: rgba(255, 255, 255, 0.9);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    z-index: 999;
    overflow: auto;
  }
</style>

<!-- Start Component -->
{% block vis_echarts %}
<div class="floating-window" id="floatingWindow"></div>
<script type="text/javascript">
  // Initialize ECharts
  var myChart = echarts.init(document.getElementById('floatingWindow'));

  const blueVioletPalette = [
    '#cddcf9',
    '#4169E1',
    '#483D8B',
    '#6A5ACD',
    '#7B68EE',
    '#781679'
  ];

  if (myChart) {
    // Load the BR map data
    $.get("{% static 'data/geo/BR.json' %}", function (brJson) {
      // Log the loaded geographic data
      myChart.hideLoading();
      echarts.registerMap('BR', brJson);

      var br_data = {{ br_data|safe }};
      
      var map_title = "Cumulative dengue cases by State in {{ current_year|safe }}";
      var chart_title = "Cumulative dengue cases by State in {{ current_year|safe }}";
      var min_total_cases = {{ min_total_cases|safe }};
      var max_total_cases = {{ max_total_cases|safe }};

      br_data.sort(function (a, b) {
        return a.value - b.value;
      });

      const mapOption = {
        title: {
          text: map_title,
          left: 'center',
          padding: [20, 0, 0, 0]
        },
        visualMap: {
          min: min_total_cases,
          max: max_total_cases,
          inRange: {
            type: 'continuous',
            color: blueVioletPalette,
            opacity: 0.8
          },
          text: ['High', 'Low'],
          calculable: true,
          orient: 'vertical',
          top: '57%',
          left: '10%',
        },
        series: [
          {
            id: 'total_cases',
            type: 'map',
            roam: true,
            mapType: 'BR',
            animationDurationUpdate: 2000,
            universalTransition: true,
            data: br_data,
          }
        ],
      };

      const barOption = {
        grid: {
          left: '15%'
        },
        title: {
          text: chart_title,
          left: 'center',
          padding: [20, 0, 0, 0] // adds margin-top
        },
        xAxis: {
          type: 'value'
        },
        yAxis: {
          type: 'category',
          axisLabel: {
            rotate: 55, 
            interval: 0,
            fontSize: 15,
          },
          data: br_data.map(function (item) {
            return item.name;
          })
        },
        animationDurationUpdate: 1000,
        series: {
          type: 'bar',
          id: 'total_cases',
          data: br_data.map(function (item) {
            return item.value;
          }),
          universalTransition: true
        },
        responsive: true
      };

      let currentOption = mapOption;

      myChart.setOption(mapOption);

      setInterval(function () {
        currentOption = currentOption === mapOption ? barOption : mapOption;
        myChart.setOption(currentOption, true);
      }, 5000);
      // Resize the chart when the window is resized
      window.addEventListener('resize', function() {
        myChart.resize();
      });
    });
  }
</script>
{% endblock %}
