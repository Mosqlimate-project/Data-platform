# Generated by Django 4.2.23 on 2026-01-05 21:41

from django.db import migrations
from urllib.parse import urlparse


def migrate_predictions(apps, schema_editor):
    Prediction = apps.get_model("registry", "Prediction")
    Repository = apps.get_model("registry", "Repository")
    QuantitativePrediction = apps.get_model(
        "registry", "QuantitativePrediction"
    )
    QuantitativePredictionRow = apps.get_model(
        "registry", "QuantitativePredictionRow"
    )
    Adm1 = apps.get_model("datastore", "Adm1")
    Adm2 = apps.get_model("datastore", "Adm2")

    repo_model_cache = {}

    for old_pred in Prediction.objects.all().select_related(
        "model", "adm_1", "adm_2"
    ):
        repo_string = old_pred.model.repository.strip()
        repo_key = repo_string
        parsed = urlparse(repo_string)
        path = parsed.path.strip("/")
        parts = path.split("/")
        owner = None
        name = None

        if len(parts) >= 2:
            owner = parts[0]
            name = parts[1].replace(".git", "")
        elif len(parts) == 1 and "/" in repo_string:
            manual_parts = repo_string.split("/")
            if len(manual_parts) >= 2:
                owner = manual_parts[0]
                name = manual_parts[1].replace(".git", "")

        if owner and name:
            repo_key = f"{owner}/{name}"

        if repo_key in repo_model_cache:
            new_repo_model = repo_model_cache[repo_key]
        else:
            repository = None
            if name:
                repository = Repository.objects.filter(name=name).first()

            if not repository:
                repository = Repository.objects.filter(
                    repo_id=repo_string
                ).first()

            if not repository:
                raise ValueError(f"Repository not found for {repo_string}")

            if hasattr(repository, "model"):
                new_repo_model = repository.model
                repo_model_cache[repo_key] = new_repo_model
            else:
                raise ValueError(
                    f"Repository {repository.name} has no RepositoryModel"
                )
        new_adm1 = None
        new_adm2 = None

        if old_pred.adm_1:
            new_adm1 = Adm1.objects.filter(
                geocode=old_pred.adm_1.geocode
            ).first()

        if old_pred.adm_2:
            new_adm2 = Adm2.objects.filter(
                geocode=old_pred.adm_2.geocode
            ).first()

        new_pred = QuantitativePrediction.objects.create(
            model=new_repo_model,
            adm1=new_adm1,
            adm2=new_adm2,
            commit=old_pred.commit,
            description=old_pred.description,
            predict_date=old_pred.predict_date,
            published=old_pred.published,
            created_at=old_pred.created,
            mae_score=old_pred.mae,
            mse_score=old_pred.mse,
            crps_score=old_pred.crps,
            log_score=old_pred.log_score,
            interval_score=old_pred.interval_score,
            wis_score=old_pred.wis,
        )

        old_rows = old_pred.data.all()
        new_rows = []

        for row in old_rows:
            new_rows.append(
                QuantitativePredictionRow(
                    prediction=new_pred,
                    date=row.date,
                    pred=row.pred,
                    lower_95=row.lower_95,
                    lower_90=row.lower_90,
                    lower_80=row.lower_80,
                    lower_50=row.lower_50,
                    upper_50=row.upper_50,
                    upper_80=row.upper_80,
                    upper_90=row.upper_90,
                    upper_95=row.upper_95,
                )
            )

        if new_rows:
            QuantitativePredictionRow.objects.bulk_create(
                new_rows, batch_size=2000
            )


class Migration(migrations.Migration):
    dependencies = [
        ("registry", "0072_alter_modelprediction_model_and_more"),
        ("datastore", "0013_populate_brazil_adms"),
    ]

    operations = [
        migrations.RunPython(migrate_predictions),
    ]
